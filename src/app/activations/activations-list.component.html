<section class="container my-4">
  <h1 class="h3 mb-3">Activations</h1>

    <!-- On-Air Activations Map -->
    <div class="mb-3">
      <app-on-air-map></app-on-air-map>
    </div>

  <div *ngIf="loading" class="alert alert-info">Loading activations…</div>
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

  <div *ngIf="!loading && !error && items.length === 0" class="alert alert-warning">
    No activations found.
  </div>

  <div class="row g-3" *ngIf="!loading && !error && items.length > 0">
    <div class="col-12 col-md-6 col-lg-4" *ngFor="let item of items; trackBy: trackById">
      <div class="card h-100 shadow-sm">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h5 mb-0 d-flex align-items-center">
              <span class="badge rounded-pill bg-primary me-2" *ngIf="item.location?.category">{{ item.location?.category | underscoreToSpace }}</span>
              <ng-container *ngIf="item.location as loc; else fallbackLoc">
                <span *ngIf="loc.location; else qthOrCoords">{{ loc.location | underscoreToSpace }}</span>
                <ng-template #qthOrCoords>
                  <span *ngIf="loc.qth; else coordsOrId">{{ loc.qth | underscoreToSpace }}</span>
                </ng-template>
                <ng-template #coordsOrId>
                  <span *ngIf="(loc.latitude || loc.longitude); else idOnly">{{ loc.latitude }}, {{ loc.longitude }}</span>
                </ng-template>
                <ng-template #idOnly>
                  <span class="badge rounded-pill bg-secondary">Site #{{ loc.id || item.activation.siteId || item.activation['site_id'] || item.activation.id }}</span>
                </ng-template>
              </ng-container>
              <ng-template #fallbackLoc>
                <span class="badge rounded-pill bg-secondary">Site #{{ item.activation.siteId || item.activation['site_id'] || item.activation.id }}</span>
              </ng-template>
            </h2>
            <span class="badge bg-secondary d-flex align-items-center gap-2">
              <img [src]="getDisplayStatus(item.activation) | statusIcon"
                   [alt]="getDisplayStatus(item.activation) | underscoreToSpace"
                   [title]="getDisplayStatus(item.activation) | underscoreToSpace"
                   style="height:20px; vertical-align:middle;">
              <span class="text-uppercase small">{{ getDisplayStatus(item.activation) | underscoreToSpace }}</span>
            </span>
          </div>

          <!-- QTH explicit line if available -->
          <div class="text-muted small mb-1" *ngIf="item.location?.qth">QTH: {{ item.location?.qth | underscoreToSpace }}</div>

          <!-- Embedded OSM map under the Site name with a pin at the site's location -->
          <div *ngIf="item.location?.latitude != null && item.location?.longitude != null" class="mb-2">
            <iframe
              [src]="buildOsmEmbedUrlSafe(item.location?.latitude, item.location?.longitude, 13)"
              [title]="(item.location?.location || item.location?.qth || ('Site #' + item.location?.id))"
              width="100%"
              height="180"
              style="border:0; border-radius: 0.25rem; overflow: hidden;"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
            ></iframe>
          </div>

          <div class="text-muted small mb-2">
            <span *ngIf="(item.activation.callsign || item.activation['user']?.callsign)">By {{ item.activation.callsign || item.activation['user']?.callsign }}</span>
            <span *ngIf="item.activation.startedAt"> · Start: {{ item.activation.startedAt | date:'short' }}</span>
            <span *ngIf="isOnAir(item.activation) && getUptime(item.activation)"> · Uptime: {{ getUptime(item.activation) }}</span>
          </div>
          <p class="mb-3" *ngIf="item.activation.description">{{ item.activation.description | underscoreToSpace }}</p>

          <div class="mt-auto">
            <div class="small text-uppercase text-muted mb-1">Latest update</div>
            <div *ngIf="item.latestPost; else noPost">
              <div class="small mb-1" *ngIf="item.latestPost.createdAt">
                {{ item.latestPost.createdAt | date:'short' }}

              </div>
              <div>{{ (item.latestPost['title'] || item.latestPost['body'] || item.latestPost['content']) | underscoreToSpace }}  <span *ngIf="item.latestPostAuthor"> · By {{ item.latestPostAuthor }}</span></div>
            </div>
            <ng-template #noPost>
              <div class="text-muted">No updates yet.</div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
